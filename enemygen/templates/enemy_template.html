{% extends "base.html" %}
{% load static %}

{% block title %}MeG: {{ et.name }}{% endblock %}

{% block content %}

<script>
$(document).ready(function(){
    document.getElementById('tag_container').addEventListener('keypress', function(event) {
        if (event.keyCode == 13) { event.preventDefault(); }
    })
    var cly = completely(document.getElementById('et_newtag'), {
        fontSize: '12px',
    	 fontFamily : 'Arial',
        color: 'black',
    });
    cly.input.style.border= '1px solid #ABADB3';
    cly.input.style.width= '200px';
    cly.wrapper.style.width= '200px';
    cly.input.style.padding='1px';
    cly.options = [{% for t in all_et_tags %}'{{t}}',{% endfor %}];
    cly.onEnter = function(){
        var new_value = cly.getText();
        var item_id = {{ et.id }};
        var item_type = 'et_newtag';
        var input_object = null;
        submit(item_id, item_type, input_object, new_value);
        var tags = new_value.split(',');
        for (i in tags){
            var tag = tags[i].trim();
            $('#tag_container').append('<div class="tag">'+tag+'         \
            <img class="del_tag" src="{% static 'images/del_tag.png' %}" \
                    et_id="{{ et.id }}" value="'+tag+'"                           \
                    onmouseover="this.src=\'{% static 'images/del_tag_hover.png' %}\'"      \
                    onmouseout="this.src=\'{% static 'images/del_tag.png' %}\'"             \
                    onmouseup="this.src=\'{% static 'images/del_tag.png' %}\'"              \
                    onmousedown="this.src=\'{% static 'images/del_tag_active.png' %}\'" />  \
                  </div>');
            $('.del_tag').click(function(event){
                deltag(event);
            })
        }
        cly.setText('');
    };
    cly.onChange = function(){
        text = capitalize(cly.getText())
        cly.setText(text)
        if (text != ''){
            cly.repaint();
        } else {
            cly.hideDropDown();
        }
    }
    
    // namelist
    $('#et_namelist').change(function(event){
        $('#namelist_link').remove();
        var namelist_id = parseInt($(event.target).val())
        if (namelist_id > 0){
            console.log(namelist_id);
            $('#namelist_cell').append('<a id="namelist_link" href="/feature_items/'+ namelist_id +'/" target=_blank>View names</a>')
        }
    })
  $('#txtHint').focus(function(){  // For some reason IE takes focus to the hint input instead of the text input
    $('#txtInput').focus();
  });
  
  $('#toggle_pro_skills').click(function(event){
    $('#professional_skills_table').toggle();
  });

  $('#folk_spells_header').click(function(event){
    $('#folk_spells_container_inner').toggle();
  });

  $('#theism_spells_header').click(function(event){
    $('#theism_spells_container_inner').toggle();
  });

  $('#sorcery_spells_header').click(function(event){
    $('#sorcery_spells_container_inner').toggle();
  });

  $('#mysticism_spells_header').click(function(event){
    $('#mysticism_spells_container_inner').toggle();
  });

  $('#spirits_header').click(function(event){
    $('#spirits_container_inner').toggle();
  });
});
</script>

<style>
/* Hide spinners on number inputs within enemy template page */
#main_content input[type=number]::-webkit-outer-spin-button,
#main_content input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
#main_content input[type=number] { -moz-appearance: textfield; }
</style>

<!-- Actions -->
<div class="card shadow-sm mb-3">
  <div class="card-body d-flex flex-wrap gap-2">
    <form action="{% url 'delete_template' et.id %}" method="post" class="me-2">
      {% csrf_token %}
      <button id="delete_template" type="submit" class="btn btn-outline-danger">Delete template</button>
    </form>
    <form id="clone_template_container" action="{% url 'clone_template' et.id %}" method="post" class="me-2">
      {% csrf_token %}
      <button id="clone_template" type="submit" class="btn btn-outline-secondary">Clone</button>
    </form>
    <form id="generate_enemy_container" action="{% url 'generate_enemies' %}" method="post" target="generated" class="ms-auto">
      {% csrf_token %}
      <input name="enemy_template_id_{{et.id}}" type="hidden" value="6">
      <button type="submit" class="btn btn-primary" style="min-width:140px;">Generate</button>
    </form>
  </div>
</div>

<!-- Enemy details -->
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex align-items-center gap-2 mb-2">
      <h3 class="h5 mb-0">Enemy details</h3>
      {% if et.starred %}
        <img et_id={{ et.id }} class="star" height="22" width="22" src="{% static 'images/star_filled.png' %}" />
      {% else %}
        <img et_id={{ et.id }} class="star" height="22" width="22" src="{% static 'images/star_empty.png' %}" />
      {% endif %}
      <span class="generated_amount text-muted small">(Generated {{ et.generated }} times)</span>
    </div>

    <div class="row g-3 align-items-center mb-2">
      <div class="col-12 col-md-3"><label for="et_{{ et.id }}" class="form-label mb-0">Template name</label></div>
      <div class="col-12 col-md-9"><input id="et_{{ et.id }}" class="data form-control" type="text" size="40" item_id="{{ et.id }}" item_type="et_name" value="{{ et.name }}" /></div>
    </div>

    <div class="row g-3 align-items-center mb-2">
      <div class="col-12 col-md-3"><label for="et_namelist" class="form-label mb-0">Random name list</label></div>
      <div class="col-12 col-md-9" id="namelist_cell">
        <select id="et_namelist" class="data form-select w-auto d-inline-block" item_id="{{ et.id }}" item_type="et_namelist">
          <option value="0" {% if et.namelist == 0 %}selected="selected"{% endif %}>None</option>
          {% for namelist in namelists %}
            <option value="{{namelist.id}}" {% if et.namelist.id == namelist.id %}selected="selected"{% endif %}>{{namelist.name}}</option>
          {% endfor %}
        </select>
        {% if et.namelist %}<a id="namelist_link" class="ms-2" href="{% url 'feature_items' et.namelist.id %}" target=_blank>View names</a>{% endif %}
      </div>
    </div>

    <div class="row g-3 align-items-start mb-2">
      <div class="col-12 col-md-3"><label class="form-label mb-0">Tags</label></div>
      <div class="col-12 col-md-9">
        <div id="tag_container" class="d-flex flex-wrap gap-1 mb-1">
          {% for tag in et.get_tags %}<div class="tag badge bg-secondary">{{ tag }}
            <img class="del_tag ms-1" src="{% static 'images/del_tag.png' %}"
                 et_id="{{ et.id }}" value="{{ tag }}"
                 onmouseover="this.src='{% static 'images/del_tag_hover.png' %}'"
                 onmouseout="this.src='{% static 'images/del_tag.png' %}'"
                 onmouseup="this.src='{% static 'images/del_tag.png' %}'"
                 onmousedown="this.src='{% static 'images/del_tag_active.png' %}'" />
          </div>{% endfor %}
        </div>
        <div id="et_newtag" class="data" type="text" item_id="{{ et.id }}" item_type="et_newtag" style="height: 18px;"></div>
      </div>
    </div>

    <div class="row g-3 align-items-center mb-2">
      <div class="col-12 col-md-3"><label for="et_rank_{{ et.id }}" class="form-label mb-0">Rank</label></div>
      <div class="col-12 col-md-9"><select id="et_rank_{{ et.id }}" class="data form-select w-auto" item_id="{{ et.id }}" item_type="et_rank">
        <option value="1" {% if et.rank == 1 %}selected="selected"{% endif %}>Rabble</option>
        <option value="2" {% if et.rank == 2 %}selected="selected"{% endif %}>Novice</option>
        <option value="3" {% if et.rank == 3 %}selected="selected"{% endif %}>Skilled</option>
        <option value="4" {% if et.rank == 4 %}selected="selected"{% endif %}>Veteran</option>
        <option value="5" {% if et.rank == 5 %}selected="selected"{% endif %}>Master</option>
      </select></div>
    </div>

    <div class="row g-3 align-items-center mb-2">
      <div class="col-12 col-md-3"><span class="form-label mb-0">Race</span></div>
      <div class="col-12 col-md-9"><a class="edit_item" href="{% url 'race' et.race.id %}">{{ et.race.name }}</a></div>
    </div>

    <div class="row g-3 align-items-center mb-2">
      <div class="col-12 col-md-3"><label for="et_cult_rank_{{ et.id }}" class="form-label mb-0">Cult Rank</label></div>
      <div class="col-12 col-md-9">
        <select id="et_cult_rank_{{ et.id }}" class="data form-select w-auto" item_id="{{ et.id }}" item_type="et_cult_rank">
          {% if et.is_theist %}
            <option value="0" {% if et.cult_rank == 0 %}selected="selected"{% endif %}>None</option>
            <option value="1" {% if et.cult_rank == 1 %}selected="selected"{% endif %}>Lay Member</option>
            <option value="2" {% if et.cult_rank == 2 %}selected="selected"{% endif %}>Initiate</option>
            <option value="3" {% if et.cult_rank == 3 %}selected="selected"{% endif %}>Acolyte</option>
            <option value="4" {% if et.cult_rank == 4 %}selected="selected"{% endif %}>Priest</option>
            <option value="5" {% if et.cult_rank == 5 %}selected="selected"{% endif %}>High Priest</option>
          {% else %}
            <option value="0" {% if et.cult_rank == 0 %}selected="selected"{% endif %}>None</option>
            <option value="1" {% if et.cult_rank == 1 %}selected="selected"{% endif %}>Common</option>
            <option value="2" {% if et.cult_rank == 2 %}selected="selected"{% endif %}>Dedicated</option>
            <option value="3" {% if et.cult_rank == 3 %}selected="selected"{% endif %}>Proven</option>
            <option value="4" {% if et.cult_rank == 4 %}selected="selected"{% endif %}>Overseer</option>
            <option value="5" {% if et.cult_rank == 5 %}selected="selected"{% endif %}>Leader</option>
          {% endif %}
        </select>
      </div>
    </div>

    <div class="row g-3 align-items-center mb-2">
      <div class="col-12 col-md-3"><label for="et_pub_{{ et.id }}" class="form-label mb-0">Published</label></div>
      <div class="col-12 col-md-9">
        <div class="form-check">
          <input id="et_pub_{{ et.id }}" class="data form-check-input" type="checkbox" item_id="{{ et.id }}" item_type="et_published" {% if et.published %}checked="checked"{% endif %} />
          <label class="form-check-label" for="et_pub_{{ et.id }}">Published</label>
        </div>
      </div>
    </div>

    <div class="row g-3 align-items-start">
      <div class="col-12 col-md-3"><label for="et_notes_{{ et.id }}" class="form-label mb-0">Notes</label></div>
      <div class="col-12 col-md-9"><textarea id="et_notes_{{ et.id }}" class="data form-control" cols="60" rows="3" item_id="{{ et.id }}" item_type="et_notes">{{ et.notes }}</textarea></div>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm mb-3 h-100"><div class="card-body p-3">
      <h3 class="h6 card-title">Stats</h3>
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <tbody>
          {% for stat in et.stats %}
            <tr>
              <td style="width: 50%">{{ stat.name }}</td>
              <td><input id="stat_{{stat.id}}" class="data form-control form-control-sm" type="text" size="8" item_id="{{stat.id}}" item_type="et_stat_value" value="{{ stat.die_set }}" /></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div></div>
  </div>

  {% if et.hit_locations %}
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm mb-3 h-100"><div class="card-body p-3">
      <h3 class="h6 card-title">Hit locations</h3>
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead><tr><th>D20</th><th>Hit location</th><th>Armor</th></tr></thead>
          <tbody>
          {% for hl in et.hit_locations %}
            <tr>
              <td>{{ hl.range|safe }}</td>
              <td>{{ hl.name }}</td>
              <td style="max-width: 10rem;"><input id="hl_{{hl.id}}" class="data form-control form-control-sm" type="text" size="10" item_id="{{hl.id}}" item_type="et_hl_armor" value="{{ hl.armor }}" /></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div></div>
  </div>
  {% endif %}

  <div class="col-12 col-lg-4">
    <div class="card shadow-sm mb-3 h-100"><div class="card-body p-3">
      <h3 class="h6 card-title">Attributes</h3>
      <div class="row g-2 align-items-center mb-2">
        <div class="col-6">Movement</div>
        <div class="col-6"><input id="movement_{{et.id}}" class="data form-control form-control-sm" type="text" size="8" item_id="{{et.id}}" item_type="et_movement" value="{{ et.movement }}" /></div>
      </div>
      <div class="form-check">
        <input id="et_natural_{{ et.id }}" class="data form-check-input" type="checkbox" item_id="{{ et.id }}" item_type="et_natural_armor" {% if et.natural_armor %}checked="checked"{% endif %} />
        <label class="form-check-label" for="et_natural_{{ et.id }}">Natural armor</label>
      </div>
    </div></div>
  </div>
</div>

{% include 'enemy_template_cults.html' %}

<!-- Additional Features -->
<div class="card shadow-sm mb-3">
  <div class="card-body p-3">
    <h3 class="h6 card-title">Additional features</h3>
    {% if et.additional_features %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-2">
          <thead><tr><th>Feature</th><th>Probability</th><th></th><th></th></tr></thead>
          <tbody>
          {% for f in et.additional_features %}
            <tr>
              <td>{{ f.name }}</td>
              <td style="max-width: 12rem;">
                <div class="input-group input-group-sm">
                  <input id="et_feature_{{f.id}}" class="data form-control" type="number" step="0.01" item_id="{{f.id}}" item_type="et_feature_prob" value="{{ f.probability }}" />
                  <span class="input-group-text">%</span>
                </div>
              </td>
              <td><img src="{% static 'minus.png' %}" width="23" height="23" class="del_item" item_id="{{ f.id }}" item_type="et_additional_feature" /></td>
              <td><a class="btn btn-link btn-sm p-0" href="{% url 'feature_items' f.feature_list.id %}">View items</a></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <select id="additional_feature_options" class="form-select w-auto">
        <option value="0">Select feature</option>
        {% for feature_list in additional_feature_lists %}
          <option value="{{ feature_list.id }}">{{ feature_list.name }}</option>
        {% endfor %}
      </select>
      <button class="add_additional_feature btn btn-outline-primary btn-sm" object_type="et" parent_id="{{ et.id }}">Add</button>
    </div>
  </div>
</div>

<!-- Non-random features -->
<div class="card shadow-sm mb-3">
  <div class="card-body p-3">
    <h3 class="h6 card-title">Non-random features</h3>
    {% if et.nonrandom_features %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-2">
          <thead><tr><th>List</th><th>Feature</th><th></th></tr></thead>
          <tbody>
          {% for feature in et.nonrandom_features %}
            <tr>
              <td>{{ feature.feature.feature_list.name }}</td>
              <td>{{ feature.feature.name }}</td>
              <td><img src="{% static 'minus.png' %}" width="23" height="23" class="del_item" item_id="{{ feature.id }}" item_type="et_nonrandom_feature" /></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
    <div class="d-flex gap-2 align-items-start flex-wrap">
      <div>
        <label for="nonrandom_feature_list_options" class="form-label">Feature list</label>
        <select id="nonrandom_feature_list_options" size="4" class="form-select" style="width: 220px">
          {% for feature_list in additional_feature_lists %}
            <option value="{{ feature_list.id }}">{{ feature_list.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex-grow-1">
        <label for="nonrandom_feature_options" class="form-label">Features</label>
        <select id="nonrandom_feature_options" size="4" class="form-select" style="min-width: 260px; width: 100%; max-width: 550px;">
          <option>&lt;Select feature list first&gt;</option>
        </select>
      </div>
      <div class="align-self-end">
        <button id="add_nonrandom_feature" class="btn btn-primary btn-sm" et_id="{{ et.id }}">Add</button>
      </div>
    </div>
  </div>
</div>

{% include 'enemy_template_skills.html' %}

{% if not et.is_spirit %}
    {% include 'enemy_template_weapons.html' %}
{% endif %}

{% include 'enemy_template_spells.html' %}

{% endblock %}
