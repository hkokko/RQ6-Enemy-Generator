#!/usr/bin/env bash
set -euo pipefail
# This project starts MySQL ONLY with the following exact Apple container command.

if ! command -v container >/dev/null 2>&1; then
  echo "Error: 'container' CLI is required (https://github.com/apple/container/releases)." >&2
  exit 1
fi

# Load MYSQL_ROOT_PASSWORD from .env if available; otherwise require it to be set in environment
ENV_FILE=${ENV_FILE:-.env}
if [ -f "$ENV_FILE" ]; then
  export $(grep -E '^(MYSQL_ROOT_PASSWORD)=' "$ENV_FILE")
fi
: "${MYSQL_ROOT_PASSWORD:?MYSQL_ROOT_PASSWORD must be set in .env or environment}"

echo "[start_db_simple] $(date)" >&2
echo "Using Apple container CLI: container" >&2
if [ -f "$ENV_FILE" ]; then echo "Loaded .env from $ENV_FILE" >&2; else echo ".env not found; relying on environment" >&2; fi
# Do not print secrets; only indicate presence
if [ -n "${MYSQL_ROOT_PASSWORD:-}" ]; then echo "MYSQL_ROOT_PASSWORD: <set>" >&2; else echo "MYSQL_ROOT_PASSWORD: <not set> (will fail)" >&2; fi

echo "Executing required command:" >&2
echo "container run \\n  --name mythras-mysql \\n  --publish 127.0.0.1:3307:3306 \\n  --volume \"$HOME/container-data/mysql:/var/lib/mysql\" \\
  --env MYSQL_ROOT_PASSWORD=*** \\
  docker.io/library/mysql:8" >&2

# Previously without a persistent volume:
# exec container run \
#   --name mythras-mysql \
#   --publish 127.0.0.1:3307:3306 \
#   --env MYSQL_ROOT_PASSWORD="$MYSQL_ROOT_PASSWORD" \
#   docker.io/library/mysql:8

exec container run \
  --name mythras-mysql \
  --publish 127.0.0.1:3307:3306 \
  --volume "$HOME/container-data/mysql:/var/lib/mysql" \
  --env MYSQL_ROOT_PASSWORD="$MYSQL_ROOT_PASSWORD" \
  docker.io/library/mysql:8
